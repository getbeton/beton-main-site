---
import { SITE } from '../../utils/site';

interface ReviewItem {
  name: string;
  role?: string;
  company?: string;
  quote: string;
}

interface PersonItem {
  name: string;
  role: string;
  bio?: string;
  social?: {
    twitter?: string;
    linkedin?: string;
    github?: string;
  };
}

interface Props {
  type?: string;
  title: string;
  description: string;
  url: string;
  faqData?: { question: string; answer: string }[];
  breadcrumbs?: { name: string; url: string }[];
  reviewData?: ReviewItem[];
  personData?: PersonItem[];
}

const { type, title, description, url, faqData, breadcrumbs, reviewData, personData } = Astro.props;

const orgSchema = {
  '@type': 'Organization',
  name: SITE.name,
  url: SITE.url,
  logo: `${SITE.url}/images/beton-logo.svg`,
  image: `${SITE.url}/images/beton-logo.png`,
  description: SITE.description,
  sameAs: [SITE.social.github, SITE.social.linkedin, SITE.social.twitter],
  contactPoint: {
    '@type': 'ContactPoint',
    url: `${SITE.url}/pricing/`,
    contactType: 'sales',
  },
};

const webSiteSchema = {
  '@type': 'WebSite',
  name: SITE.name,
  url: SITE.url,
  description: SITE.description,
  publisher: { '@type': 'Organization', name: SITE.name },
};

const webPageSchema = {
  '@type': 'WebPage',
  name: title,
  description,
  url,
  isPartOf: { '@type': 'WebSite', url: SITE.url },
  publisher: { '@type': 'Organization', name: SITE.name },
};

const softwareSchema =
  type === 'SoftwareApplication'
    ? {
        '@type': 'SoftwareApplication',
        name: SITE.name,
        applicationCategory: 'BusinessApplication',
        applicationSubCategory: 'Revenue Intelligence',
        operatingSystem: 'Web',
        description: SITE.description,
        url: SITE.url,
        publisher: { '@type': 'Organization', name: SITE.name },
        offers: [
          {
            '@type': 'Offer',
            name: 'Self-Hosted',
            price: '0',
            priceCurrency: 'USD',
            url: `${SITE.url}/pricing/`,
            availability: 'https://schema.org/InStock',
            description: 'Free self-hosted deployment with your own LLM key. GPL licensed.',
          },
          {
            '@type': 'Offer',
            name: 'Cloud',
            price: '0.50',
            priceCurrency: 'USD',
            url: `${SITE.url}/pricing/`,
            availability: 'https://schema.org/InStock',
            description: 'Per tracked user per month. Managed hosting, daily sync.',
          },
        ],
        featureList: [
          'Behavioral signal detection',
          'CRM integration (Attio, HubSpot, Zoho, Pipedrive)',
          'PostHog analytics integration',
          'Churn prediction',
          'Expansion revenue detection',
          'PLG conversion tracking',
        ],
        ...(reviewData && reviewData.length > 0
          ? {
              aggregateRating: {
                '@type': 'AggregateRating',
                ratingValue: '5',
                bestRating: '5',
                ratingCount: String(reviewData.length),
              },
              review: reviewData.map((r) => ({
                '@type': 'Review',
                author: {
                  '@type': 'Person',
                  name: r.name,
                  ...(r.role && { jobTitle: r.role }),
                },
                reviewBody: r.quote,
                reviewRating: {
                  '@type': 'Rating',
                  ratingValue: '5',
                  bestRating: '5',
                },
                ...(r.company && {
                  publisher: { '@type': 'Organization', name: r.company },
                }),
              })),
            }
          : {}),
      }
    : null;

const faqSchema =
  faqData && faqData.length > 0
    ? {
        '@type': 'FAQPage',
        mainEntity: faqData.map((item) => ({
          '@type': 'Question',
          name: item.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: item.answer,
          },
        })),
      }
    : null;

const breadcrumbSchema =
  breadcrumbs && breadcrumbs.length > 0
    ? {
        '@type': 'BreadcrumbList',
        itemListElement: breadcrumbs.map((crumb, i) => ({
          '@type': 'ListItem',
          position: i + 1,
          name: crumb.name,
          item: crumb.url,
        })),
      }
    : null;

const personSchemas =
  personData && personData.length > 0
    ? personData.map((p) => ({
        '@type': 'Person',
        name: p.name,
        jobTitle: p.role,
        ...(p.bio && { description: p.bio }),
        worksFor: {
          '@type': 'Organization',
          name: SITE.name,
          url: SITE.url,
        },
        sameAs: [
          ...(p.social?.twitter ? [p.social.twitter] : []),
          ...(p.social?.linkedin ? [p.social.linkedin] : []),
          ...(p.social?.github ? [p.social.github] : []),
        ].filter(Boolean),
      }))
    : null;

const graph: Record<string, unknown>[] = [orgSchema, webSiteSchema, webPageSchema];
if (softwareSchema) graph.push(softwareSchema);
if (faqSchema) graph.push(faqSchema);
if (breadcrumbSchema) graph.push(breadcrumbSchema);
if (personSchemas) graph.push(...personSchemas);

const consolidatedSchema = {
  '@context': 'https://schema.org',
  '@graph': graph,
};
---

<script type="application/ld+json" set:html={JSON.stringify(consolidatedSchema)} />
