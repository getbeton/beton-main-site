---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import Container from '../../components/ui/Container.astro';
import Button from '../../components/ui/Button.astro';
import CTASection from '../../components/shared/CTASection.astro';
import { SITE } from '../../utils/site';

export async function getStaticPaths() {
  const agents = await getCollection('agents');
  return agents.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { name, slug, tagline, description, vendor, category, accentColor, mcpSetup, examplePrompts, capabilities, workflows, faq, seo } = entry.data;

const breadcrumbs = [
  { name: 'Home', url: SITE.url },
  { name: 'For AI Agents', url: `${SITE.url}/for/` },
  { name: `Beton + ${name}`, url: `${SITE.url}/for/${slug}/` },
];

/** Convert backtick-wrapped text to inline <code> elements */
function renderInlineCode(text: string): string {
  return text.replace(
    /`([^`]+)`/g,
    '<code class="inline-code">$1</code>'
  );
}

/** SVG icons for capabilities — 5 distinct icons cycled by index */
const capabilityIcons = [
  { path: 'M9.348 14.652a3.75 3.75 0 010-5.304m5.304 0a3.75 3.75 0 010 5.304m-7.425 2.121a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.788m13.788 0c3.808 3.808 3.808 9.98 0 13.788M12 12h.008v.008H12V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z', label: 'Signal detection' },
  { path: 'M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z', label: 'Lead scoring' },
  { path: 'M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5', label: 'Signal routing' },
  { path: 'M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z', label: 'Account analysis' },
  { path: 'M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z', label: 'Signal filtering' },
];

/** SVG icons for workflows — 3 icons cycled by index */
const workflowIcons = [
  'M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z',
  'M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605',
  'M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z',
];

const textColor = accentColor === '#F0E442' ? '#1a1a1a' : '#ffffff';
---

<PageLayout
  title={seo?.metaTitle || `Beton + ${name}`}
  description={seo?.metaDescription || description}
  canonicalPath={`/for/${slug}`}
  breadcrumbs={breadcrumbs}
  faqData={faq}
>
  <!-- Hero -->
  <section class="relative py-14 lg:py-20 overflow-hidden">
    <div class="absolute inset-0 -z-10" aria-hidden="true">
      <div class="absolute top-0 left-0 right-0 h-2" style={`background: ${accentColor};`}></div>
      <div class="absolute -top-24 -right-24 w-96 h-96 opacity-25 blur-3xl" style={`background: ${accentColor};`}></div>
      <div class="absolute -bottom-24 -left-24 w-72 h-72 opacity-15 blur-3xl" style={`background: ${accentColor};`}></div>
    </div>
    <Container>
      <div class="max-w-3xl">
        <span class="inline-flex items-center px-3 py-1 text-xs font-bold uppercase tracking-wider border-2 border-[var(--color-text)] bg-[var(--color-surface-raised)] mb-6">
          MCP Integration
        </span>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-[family-name:var(--font-heading)] tracking-wide leading-[1.1] mb-4">
          Beton + {name}
        </h1>

        <p class="text-lg sm:text-xl text-[var(--color-text-secondary)] leading-relaxed mb-2">
          {tagline}
        </p>
        <p class="text-sm text-[var(--color-text-tertiary)] mb-8">
          {vendor} &middot; {category}
        </p>

        <div class="flex flex-col sm:flex-row gap-3">
          <Button href={SITE.external.app} size="lg" data-track-cta={`agent-${slug}-hero`}>
            Get Started Free
          </Button>
        </div>
      </div>
    </Container>
  </section>

  <!-- Capabilities -->
  <section class="py-10 lg:py-16 bg-[var(--color-surface-raised)] border-y-2 border-[var(--color-border)]">
    <Container>
      <h2 class="text-2xl sm:text-3xl font-[family-name:var(--font-heading)] tracking-wide text-center mb-10">
        WHAT {name.toUpperCase()} CAN DO WITH BETON
      </h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
        {capabilities.map((cap, i) => {
          const icon = capabilityIcons[i % capabilityIcons.length];
          return (
            <div class="border-2 border-[var(--color-text)] p-5 border-l-[6px]" style={`border-left-color: ${accentColor};`}>
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 shrink-0 mt-0.5" style={`color: ${accentColor};`} fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" role="img" aria-label={icon.label}>
                  <title>{icon.label}</title>
                  <path stroke-linecap="round" stroke-linejoin="round" d={icon.path} />
                </svg>
                <span class="text-sm text-[var(--color-text-secondary)] leading-relaxed">{cap}</span>
              </div>
            </div>
          );
        })}
      </div>
    </Container>
  </section>

  <!-- Example Prompts -->
  <section class="py-10 lg:py-16">
    <Container>
      <h2 class="text-2xl sm:text-3xl font-[family-name:var(--font-heading)] tracking-wide text-center mb-10">
        EXAMPLE PROMPTS
      </h2>
      <div class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto">
        {examplePrompts.map((example) => (
          <div class="border-2 border-[var(--color-text)] shadow-[var(--shadow-card)]">
            <div class="flex items-center gap-2 px-4 py-2 border-b-2 border-[var(--color-text)]" style={`background: ${accentColor};`}>
              <span class="text-xs font-[family-name:var(--font-mono)] font-bold uppercase tracking-wider" style={`color: ${textColor};`}>
                PROMPT
              </span>
            </div>
            <div class="p-4">
              <p class="text-sm font-[family-name:var(--font-mono)] text-[var(--color-text)] leading-relaxed mb-3">
                &gt; {example.prompt}
              </p>
              <p class="text-xs text-[var(--color-text-tertiary)] leading-relaxed">
                {example.description}
              </p>
            </div>
          </div>
        ))}
      </div>
    </Container>
  </section>

  <!-- MCP Setup -->
  <section class="py-10 lg:py-16 bg-[var(--color-surface-raised)] border-y-2 border-[var(--color-border)]">
    <Container>
      <h2 class="text-2xl sm:text-3xl font-[family-name:var(--font-heading)] tracking-wide text-center mb-4">
        CONNECT BETON TO {name.toUpperCase()}
      </h2>
      <p class="text-sm text-[var(--color-text-tertiary)] text-center max-w-2xl mx-auto mb-10">
        Beton connects your data source (PostHog) to your destinations (Attio, HubSpot, Pipedrive, and more) via MCP. {name} acts as the interface — talk to your revenue data in natural language.
      </p>
      <div class="max-w-3xl mx-auto">
        <!-- Steps -->
        <div class="space-y-4 mb-8">
          {mcpSetup.steps.map((step, i) => (
            <div class="flex items-start gap-4">
              <div class="inline-flex items-center justify-center w-8 h-8 shrink-0 border-2 border-[var(--color-text)] font-bold text-sm font-[family-name:var(--font-heading)]" style={`background: ${accentColor}; color: ${textColor};`}>
                {i + 1}
              </div>
              <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed pt-1" set:html={renderInlineCode(step)} />
            </div>
          ))}
        </div>

        <!-- Config code block -->
        <div class="border-2 border-[var(--color-text)] bg-[var(--color-surface)]">
          <div class="flex items-center justify-between px-4 py-2 border-b-2 border-[var(--color-text)]" style={`background: ${accentColor};`}>
            <span class="text-xs font-[family-name:var(--font-mono)] font-bold uppercase tracking-wider" style={`color: ${textColor};`}>
              {mcpSetup.configFile}
            </span>
            <button
              type="button"
              class="copy-btn inline-flex items-center gap-1.5 px-2 py-1 text-xs font-bold uppercase tracking-wider border border-current opacity-80 hover:opacity-100 transition-opacity cursor-pointer"
              style={`color: ${textColor};`}
              data-config={mcpSetup.configSnippet}
              aria-label="Copy configuration to clipboard"
            >
              <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
              </svg>
              <span class="copy-label">Copy</span>
            </button>
          </div>
          <pre class="p-4 overflow-x-auto text-sm font-[family-name:var(--font-mono)] leading-relaxed text-[var(--color-text)]"><code>{mcpSetup.configSnippet}</code></pre>
        </div>

        <p class="text-xs text-[var(--color-text-tertiary)] mt-3">
          Replace <code class="inline-code">your-api-key</code> with your Beton API key from <a href={SITE.external.app} class="underline hover:text-[var(--color-text)]">your dashboard</a>.
        </p>
      </div>
    </Container>
  </section>

  <!-- Workflows -->
  <section class="py-10 lg:py-16">
    <Container>
      <h2 class="text-2xl sm:text-3xl font-[family-name:var(--font-heading)] tracking-wide text-center mb-10">
        REVENUE OPS WORKFLOWS
      </h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
        {workflows.map((wf, i) => (
          <div class="border-2 border-[var(--color-text)] shadow-[var(--shadow-card)] flex flex-col">
            <div class="flex items-center gap-3 px-5 py-3 border-b-2 border-[var(--color-border)]">
              <div class="inline-flex items-center justify-center w-8 h-8 shrink-0 border-2 border-[var(--color-text)]" style={`background: ${accentColor};`}>
                <svg class="w-4 h-4" style={`color: ${textColor};`} fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d={workflowIcons[i % workflowIcons.length]} />
                </svg>
              </div>
              <h3 class="text-sm font-bold">{wf.title}</h3>
            </div>
            <div class="p-5 flex-1">
              <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed">{wf.description}</p>
            </div>
          </div>
        ))}
      </div>
    </Container>
  </section>

  <!-- FAQ -->
  {faq.length > 0 && (
    <section class="py-10 lg:py-16 bg-[var(--color-surface-raised)] border-y-2 border-[var(--color-border)]">
      <Container>
        <h2 class="text-2xl sm:text-3xl font-[family-name:var(--font-heading)] tracking-wide text-center mb-10">
          FREQUENTLY ASKED QUESTIONS
        </h2>
        <div class="max-w-3xl mx-auto space-y-4">
          {faq.map((item) => (
            <details class="group border-2 border-[var(--color-text)]">
              <summary class="flex items-center justify-between p-4 cursor-pointer font-bold text-sm hover:bg-[var(--color-surface-raised)]">
                {item.question}
                <svg class="w-5 h-5 shrink-0 ml-2 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </summary>
              <div class="px-4 pb-4 text-sm text-[var(--color-text-secondary)] leading-relaxed border-t-2 border-[var(--color-border)] pt-4" set:html={renderInlineCode(item.answer)} />
            </details>
          ))}
        </div>
      </Container>
    </section>
  )}

  <!-- CTA -->
  <CTASection
    headline={`Start using Beton with ${name}`}
    description={`Connect Beton to ${name} via MCP and start detecting revenue signals in minutes. Free to self-host, no credit card required.`}
    trackId={`agent-${slug}-cta`}
  />
</PageLayout>

<style is:global>
  .inline-code {
    padding: 0.125rem 0.375rem;
    font-size: 0.8125rem;
    font-family: var(--font-mono);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
  }
</style>

<script is:inline>
  document.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var config = this.getAttribute('data-config');
      var label = this.querySelector('.copy-label');
      if (navigator.clipboard && config) {
        navigator.clipboard.writeText(config).then(function() {
          label.textContent = 'Copied';
          setTimeout(function() { label.textContent = 'Copy'; }, 2000);
        });
      }
    });
  });
</script>
